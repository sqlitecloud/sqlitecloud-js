<!DOCTYPE html>
<html>

<body>
  <h2>SQLite Cloud SDK CHAT </h2>
  <!-- message form -->
  <form name="publish">
    <input type="text" name="message">
    <input type="submit" value="Send">
  </form>

  <!-- div with messages -->
  <div id="messages"></div>

  <p id="message"></p>
  <p id="connection-state"></p>
  <button id="open-connection">Open connection</button>
  <button id="close-connection">Close connection</button>
  <button id="promise-send">Send command</button>
  <button id="pub-channel">Channel1 subscription</button>
  <button id="rm-pub-channel">Remove channel1 subscription</button>
  <button id="pub-channel2">Channel2 subscription</button>
  <button id="rm-pub-channel2">Remove channel2 subscription</button>
  <script src="http://localhost:8080/main.bundle.js"></script>
  <script>

    let onErrorCallback = function (event) {
      console.log("on Error");
      console.log(event);
    }

    let onCloseCallback = function (event) {
      console.log("on Close");
      console.log(event);
    }

    let myLiter = new sqliteCloudJS.Liter("ws://localhost:8081/ws", onErrorCallback, onCloseCallback);
    //set custom requestTimeout
    myLiter.setRequestTimeout(3000);


    //Connection Open
    const openEl = document.getElementById("open-connection");
    openEl.addEventListener("click", async () => {
      const connectionResponse = await myLiter.connect();
      console.log(connectionResponse);
    }, false);

    //Connection close
    const closeEl = document.getElementById("close-connection");
    closeEl.addEventListener("click", () => {
      myLiter.close();
    }, false);

    //Exec sql command
    async function exec(id, command) {
      const response = await myLiter.exec(id, command);
      console.log(response);
    }
    const syncSendEl = document.getElementById("promise-send");
    syncSendEl.addEventListener("click", () => {
      exec(myLiter.makeid(5), "LIST DATABASES");
    }, false);


    //Register to pubSub channel
    let channel1Callback = function (message) {
      //console.log("ch1 callback: " + message);
      //document.getElementById('message').innerHTML = message;
    }

    let channel2Callback = function (message) {
      //console.log("ch2 callback: " + message);
      //document.getElementById('message').innerHTML = message;
    }

    async function pubsub(id, channel, payload, callback) {
      const response = await myLiter.pubsub(id, channel, payload, callback);
      console.log(response);
    }
    const pubChEl = document.getElementById("pub-channel");
    pubChEl.addEventListener("click", () => {
      pubsub(myLiter.makeid(5), "channel1", null, channel1Callback);
    }, false);

    const pubCh2El = document.getElementById("pub-channel2");
    pubCh2El.addEventListener("click", () => {
      pubsub(myLiter.makeid(5), "channel2", null, channel2Callback);
    }, false);

    //Remove to pubSub channel

    async function pubsub(id, channel, payload, callback) {
      const response = await myLiter.pubsub(id, channel, payload, callback);
      console.log(response);
    }
    const rmPubChEl = document.getElementById("rm-pub-channel");
    rmPubChEl.addEventListener("click", () => {
      pubsub(myLiter.makeid(5), "channel1", null, null);
    }, false);

    const rmPubCh2El = document.getElementById("rm-pub-channel2");
    rmPubCh2El.addEventListener("click", () => {
      pubsub(myLiter.makeid(5), "channel2", null, null);
    }, false);

    //Callback Send
    //const asyncSendEl = document.getElementById("callback-send");
    //asyncSendEl.addEventListener("click", () => {
    //myLiter.callbackSend(myLiter.makeid(5));
    //}, false);


    //Check connection state
    setInterval(() => {
      document.getElementById('connection-state').innerHTML = myLiter.connectionState;
    }, 200)

    //Check connection state
    //setInterval(() => {
    //  console.log(myLiter.requestsStackState);
    //}, 1000)

    //Check subscription state
    //setInterval(() => {
    //  console.log(myLiter.subscriptionsStackState);
    //}, 200)

  </script>

</body>

</html>